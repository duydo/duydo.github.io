<!DOCTYPE html>
<html lang="en-US">
<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  	<meta property="og:title" content=" How Elasticsearch cluster works &middot;  Duy Do" />
  	<meta property="og:site_name" content="Duy Do" />
  	<meta property="og:url" content="http://duydo.me/how-elasticsearch-cluster-works/" />

    
  	<meta property="og:type" content="article" />

    <meta property="og:article:published_time" content="2016-10-24T11:16:00&#43;07:00" />

    
    <meta property="og:article:tag" content="elasticsearch" />
    
    <meta property="og:article:tag" content="engineering" />
    
    <meta property="og:article:tag" content="search engine" />
    
    <meta property="og:article:tag" content="information retrieval" />
    
    

  <title>
     How Elasticsearch cluster works &middot;  Duy Do
  </title>

    <meta name="description" content="A Father. A Husband. A Software Engineer." />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://duydo.me/images/favicon.ico">
    <link rel="apple-touch-icon" href="http://duydo.me/images/apple-touch-icon.png" />

    <link rel="stylesheet" type="text/css" href="http://duydo.me/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="http://duydo.me/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400|Inconsolata" />
    
      
          <link href="http://duydo.me/index.xml" rel="alternate" type="application/rss+xml" title="Duy Do" />
      
      
    
    <meta name="generator" content="Hugo 0.17" />

    <link rel="canonical" href="http://duydo.me/how-elasticsearch-cluster-works/" />

    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-68329720-1', 'auto');
      ga('send', 'pageview');

    </script>
    

    
</head>
<body class="post-template nav-closed">
  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/">Home</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/post">Blog</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="/about">About</a>
            </li>
        
    </ul>
    
    
    <a class="subscribe-button icon-feed" href="http://duydo.me/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>

 <div class="site-wrapper">



<header class="main-header post-head no-cover">
    <nav class="main-nav clearfix">

        
        
        <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
        
    </nav>
</header>
<main class="single content" role="main">
    <article class="post post">
        <header class="post-header">
            <h1 class="post-title">How Elasticsearch cluster works</h1>
            <small></small>
            <section class="post-meta">
                
                <time class="post-date" datetime=" 2016-10-24T11:16:00&#43;07:00">
                Oct 24, 2016
                </time>
                 
                    
                     on <a class="post-tag" href="http://duydo.me/tags/elasticsearch/">elasticsearch</a>
                
                
            </section>
        </header>
        <section class="post-content">
            <p>This post is part of a series covering the architecture of Elasticsearch based on my experience while working with it. In this post, weâ€™ll be discussing how the cluster works, try to find answers for following questions:</p>

<ul>
<li>How a node in cluster talks to others?</li>
<li>What happens when a node joins or leaves the cluster?</li>
<li>What happens when a node stops or has encountered a problem?</li>
</ul>

<p></p>

<h2 id="a-cluster-of-nodes">A Cluster of Nodes</h2>

<p>When we start an instance of Elasticsearch, we are starting a <em>node</em> and we have a <em>cluster</em> with single node. We start another instance of Elasticsearch has same <code>cluster.name</code> with the first instance and we have a cluster with two nodes. We can start more instances of Elasticsearch to form a cluster with number of nodes we want.</p>

<p>Every node in the cluster knows about the other nodes within the cluster, they talk to others directly using the native Elasticsearch language over <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">TCP</a>. This is known as a <a href="http://en.wikipedia.org/wiki/Network_topology#Mesh">full connected mesh topology</a>:</p>

<p><img src="https://upload.wikimedia.org/wikipedia/commons/3/3c/NetworkTopology-FullyConnected.png" alt="full connected mesh topology" /></p>

<p><em>Figure 1. Full connected mesh topology (source <a href="https://upload.wikimedia.org/wikipedia/commons/3/3c/NetworkTopology-FullyConnected.png">https://upload.wikimedia.org/wikipedia/commons/3/3c/NetworkTopology-FullyConnected.png</a>)</em></p>

<p>Besides that, the nodes are able to talk to external world using <a href="http://www.json.org">JSON</a> &ldquo;language&rdquo; over <a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP</a>.</p>

<p>So, we can say:</p>

<blockquote>
<p>Elasticsearch is <a href="https://en.wikipedia.org/wiki/Peer-to-peer">peer-to-peer</a> based system, nodes communicate with others directly.</p>
</blockquote>

<p>Each node in the cluster plays one or more roles; it can be a <em>master</em> node, <em>data</em> node, <em>client</em> node, or <em>tribe</em> node. Ech role has it own purpose.</p>

<p><strong>The master node</strong> is responsible for creating, deleting indices, adding the nodes or remove the nodes from the cluster. Each time a cluster state is changed, the master node broadcasts the changes to other nodes in the cluster. There is only one master node in the cluster at a time.</p>

<p><strong>The data node</strong> is responsible for holding the data in the shards and performing data related operations such as create, read, update, delete, search, and aggregations. We can have many data nodes in the cluster. If one of the data nodes stops, the cluster still operates and  re-organizes the data on other nodes.</p>

<p><strong>The client node</strong> is responsible for routing the cluster-related requests to the master node and the data-related requests to the data nodes, it acts as a &ldquo;smart <a href="https://en.wikipedia.org/wiki/Router_(computing)">router</a>&rdquo;. The client node does not hold any data, it also cannot become the master node.</p>

<p><img src="/images/es_client_to_data_nodes.png" alt="es_client_to_data_nodes" />
<em>Figure 2. The client node routes the data-related request to every data nodes in the cluster.</em>
<img src="/images/es_client_to_master_node.png" alt="es_client_to_data_nodes" />
<em>Figure 3. The client node routes the cluster-related request to the master node in the cluster.</em></p>

<p><strong>The tribe node</strong> is special type of client node that is able to talk to multiple clusters to perform search and other operations.</p>

<p><strong>The ingest node</strong> is responsible for pre-processing documents before the actual indexing takes into account.</p>

<p>Now we know role of each node, next we look at what happens behind the sence when a node joins or leaves the cluster.</p>

<h2 id="add-a-node-to-the-cluster">Add a Node to the Cluster</h2>

<p>When we start a node, the node is starting to ping all the nodes in the cluster for finding the master node. Once the master  is found, it will ask the master  to join by sending a join request; the master accepts it as a new node of the cluster and then notify all the nodes in the cluster about presense of the new node, and finally the new node connects to all other nodes.</p>

<p>If the joined node is a data node, the master will reallocate the data evenly across the nodes.</p>

<h2 id="remove-a-node-from-the-cluster">Remove a Node from the Cluster</h2>

<p>If we stop a node or a node in the cluster is unresponsive in specific amout of time, the master node will remove it from the cluster and reallocate the data if the removed node is a data node.</p>

<p>You might be curious about how the master node knows if other nodes in the cluster are still alive. The master has a fault detection machanism, it pings all the other nodes in the cluster and verify that they are alive or not.</p>

<p>And about the master, what happens if it stops or has encountered a problem? Same the master node, each node in the cluster also have a fault detection machanism, it pings to master to verify if its still alive. If the master is not alive, other master-eligible nodes will be elected new master to replace the down one within seconds.</p>

<p>In the next post in this series, we will look at how Elasticsearc index data in a distributed maner.</p>
            
    
    <p class="post-tags">
    
            <a class="post-tag" href="http://duydo.me/tags/elasticsearch">elasticsearch</a>
    
            <a class="post-tag" href="http://duydo.me/tags/engineering">engineering</a>
    
            <a class="post-tag" href="http://duydo.me/tags/search-engine">search engine</a>
    
            <a class="post-tag" href="http://duydo.me/tags/information-retrieval">information retrieval</a>
    
    </p>


        </section>
        <footer class="post-footer">
            









<figure class="author-image">
    <a class="img" href="http://duydo.me/" style="background-image: url(http://duydo.me/images/duydo.jpg)">
        <span class="hidden">Duy Do's photo</span>
    </a>
</figure>

<section class="author">
    <h4><a href="http://duydo.me/">Duy Do</a></h4>
    
    <p>A Father. A Husband. A Software Engineer.</p>
    
    <div class="author-meta">
        <span class="author-location icon-location">Ho Chi Minh, Vietnam</span>
        <span class="author-link icon-link"><a href="http://duydo.me">http://duydo.me</a></span>
    </div>
</section>


            
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" style="font-size: 1.4em" href="https://twitter.com/share?text=How%20Elasticsearch%20cluster%20works&nbsp;-&nbsp;Duy%20Do&amp;url=http%3a%2f%2fduydo.me%2fhow-elasticsearch-cluster-works%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" style="font-size: 1.4em" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fduydo.me%2fhow-elasticsearch-cluster-works%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-pinterest" style="font-size: 1.4em" href="http://pinterest.com/pin/create/button/?url=http%3a%2f%2fduydo.me%2fhow-elasticsearch-cluster-works%2f&amp;description=How%20Elasticsearch%20cluster%20works"
      onclick="window.open(this.href, 'pinterest-share','width=580,height=296');return false;">
      <span class="hidden">Pinterest</span>
  </a>
  <a class="icon-google-plus" style="font-size: 1.4em" href="https://plus.google.com/share?url=http%3a%2f%2fduydo.me%2fhow-elasticsearch-cluster-works%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>


            

<div id="disqus_thread"></div>
<script type="text/javascript">
  var disqus_shortname = 'duydo';
  var disqus_url = 'http:\/\/duydo.me\/how-elasticsearch-cluster-works\/';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



        </footer>
    </article>
</main>
    <footer class="site-footer clearfix">
        <section class="copyright">
            Copyright Â© 2016 Duy Do. All rights reserved.

        </section>
        <section class="socials">
            <span class="follow-me">Follow me</span>
               
                <a class="bloglogo" href="https://twitter.com/duydo" target="_blank">
                    <span class="icon-twitter"></span>
                </a>
            &nbsp;
            
            
            
                <a class="bloglogo" href="https://github.com/duydo" target="_blank">
                <span class="icon-github"></span>
                </a>
            &nbsp;
            

            
            
            
            
        </section>
    </footer>
    </div>
    <script type="text/javascript" src="http://duydo.me/js/jquery.js"></script>
    <script type="text/javascript" src="http://duydo.me/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://duydo.me/js/index.js"></script>
    
</body>
</html>

